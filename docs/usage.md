# Splat Replay ユーザーガイド

このガイドでは、Splat Replay を使ってスプラトゥーン 3 のゲームプレイを自動録画・自動編集・自動アップロードする方法について説明します。一連の処理を自動化することで、プレイに集中しながら記録を残せます。

## 目次

1. [システム要件](#1-システム要件)
2. [インストール手順](#2-インストール手順)
3. [初期設定](#3-初期設定)
4. [使用方法](#4-使用方法)
5. [仕様概要](#5-仕様概要)
6. [カスタマイズ設定](#6-カスタマイズ設定)
7. [トラブルシューティング](#7-トラブルシューティング)

## 1. システム要件

### 1.1. ハードウェア要件

- **PC**: OBS Studio が動作するスペック、USB 3.0 ポートがある
- **キャプチャーボード**: 1080p/60fps 対応推奨
- **マイク**: 音声認識機能を使用する場合
- **Nintendo Switch**: ドックに接続された状態

### 1.2. ソフトウェア要件

- **OS**: Windows 11
- **Python**: 3.13 以上
- **uv**: パッケージ管理用
- **Node.js**: 18 以上
- **Task**: タスクランナー（ビルド・開発用）
- **OBS Studio**: 28.0 以上（WebSocket 機能を使用するため）
- **obs-ndi プラグイン**: OBS で NDI 出力を有効にするため
- **NDI 6 Runtime**: OBS の映像をアプリに取り込むため
- **FFmpeg**: 動画処理用
- **Tesseract**: OCR（文字認識）用

## 2. インストール手順

### 2.1. 必要ソフトウェアのインストール

#### 2.1.1. Python 3 のインストール

1. [Python 公式サイト](https://www.python.org/downloads/)から Python 3.13 以上をダウンロード
2. インストーラを実行し、**「Add Python to PATH」オプションを必ずチェック**してインストール
3. インストール完了後、コマンドプロンプトで`python --version`を実行して確認

#### 2.1.2. uv のインストール

1. コマンドプロンプトを管理者権限で開き、以下のコマンドを実行:
   ```
   pip install uv
   ```
2. インストール後、`uv --version`で確認

#### 2.1.3. Task のインストール

Task は本プロジェクトの標準ビルドツールです。以下のいずれかの方法でインストールしてください。

```powershell
# winget（推奨）
winget install Task.Task

# または Scoop
scoop install task

# または Chocolatey
choco install go-task
```

インストール後、`task --version`で確認してください。

#### 2.1.4. Node.js のインストール

1. [Node.js 公式サイト](https://nodejs.org/en/download/)から LTS 版（18 以上）をダウンロード
2. インストーラを実行し、デフォルト設定でインストール

#### 2.1.5. OBS Studio のインストール

1. [OBS Studio 公式サイト](https://obsproject.com/)から最新版をダウンロード
2. インストーラを実行し、デフォルト設定でインストール
3. 初回起動時の最適化ウィザードは「録画向け設定」を選択

#### 2.1.6. obs-ndi プラグインのインストール

参考サイト: [obs-ndi プラグインと NDI 6 Runtime のインストール手順](https://note.com/tkykmts/n/nb78d5fd2cd6c)

1. [obs-ndi プラグインのリリースページ](https://github.com/Palakis/obs-ndi/releases)から最新のリリース(`Windows-x64-installer.exe`)をダウンロード
2. インストーラを実行し、デフォルト設定でインストール

#### 2.1.7. NDI 6 Runtime のインストール

1. [NDI 公式サイト](https://www.faronics.com/ja/apps/ndi-6-runtime)から NDI 6 Runtime をダウンロード
2. インストーラを実行し、デフォルト設定でインストール

#### 2.1.8. FFmpeg のインストール

1. [FFmpeg 公式サイト](https://ffmpeg.org/download.html)から最新の Windows 用ビルドをダウンロード
2. ダウンロードした zip ファイルを解凍し、例えば`C:\ffmpeg`などの場所に配置
3. システム環境変数 PATH に`C:\ffmpeg\bin`を追加
4. コマンドプロンプトで`ffmpeg -version`を実行して確認

#### 2.1.9. Tesseract のインストール

1. [UB-Mannheim のリポジトリ](https://github.com/UB-Mannheim/tesseract/wiki)から最新の Tesseract-OCR をダウンロード
2. インストーラを実行し、「Additional language data」で「English」を選択
3. インストール後、以下の追加データをダウンロード:
   - [best 版 eng データ](https://github.com/tesseract-ocr/tessdata_best/raw/master/eng.traineddata)
   - ダウンロードしたファイルを`C:\Program Files\Tesseract-OCR\tessdata`に上書き保存
4. 環境変数 PATH に Tesseract のインストールパス（例: `C:\Program Files\Tesseract-OCR`）を追加
   ```
   # 管理者権限のコマンドプロンプトで実行
   setx PATH "%PATH%;C:\Program Files\Tesseract-OCR" /M
   ```

### 2.2 必要ファイル・データの取得

#### 2.2.1. イカモドキフォントのダウンロード

1. [イカモドキフォント配布ページ](https://web.archive.org/web/20150906013956/http://aramugi.com/?page_id=807)からフォントをダウンロード
2. ダウンロードしたフォントファイルをインストールせずに保存（後で配置します）

#### 2.2.2. YouTube API 認証設定

1. [Google Cloud Console](https://console.cloud.google.com/)で新しいプロジェクトを作成
2. YouTube Data API v3 を有効化
3. 認証情報ページで「OAuth 2.0 クライアント ID」を作成:
   - アプリケーションの種類: デスクトップアプリケーション
   - リダイレクト URI: `http://localhost:8080/`
4. 作成した認証情報の「JSON をダウンロード」をクリックし、`client_secret.json`として保存（後で配置します）
5. YouTube チャンネルの確認と登録を完了する

#### 2.2.3. Groq API キーの取得（文字起こしを使用する場合のみ）

1. [Groq 公式サイト](https://console.groq.com/)でアカウント作成
2. API キーを生成して安全な場所に保存（後で設定します）

### 2.3. アプリケーションのセットアップ

#### 2.3.1. リポジトリのクローンとビルド

1. Git リポジトリをクローンします：

   ```bash
   git clone https://github.com/saw4405/splat-replay2.git
   cd splat-replay2
   ```

2. アプリケーションをビルドします：

   ```bash
   task build
   ```

   ビルドが成功すると、`backend/dist/SplatReplay/`ディレクトリに実行可能ファイルが生成されます。
   詳細は [ビルドガイド](./build_guide.md) を参照してください。

#### 2.3.2. イカモドキフォントの配置

1. ダウンロードしたイカモドキフォントを`backend/dist/SplatReplay/assets/thumbnail`フォルダに配置

#### 2.3.3. YouTube API 認証情報の配置

1. ダウンロードした`client_secret.json`を`backend/dist/SplatReplay/config`フォルダに配置

## 4. 使用方法

### 4.1. 機器接続

1. Nintendo Switch からキャプチャーボードを通して PC に接続

   接続例：

   ```mermaid
   graph LR
      Switch[Switch] -- HDMI --> CaptureBoard[キャプチャボード]
      CaptureBoard -- USB --> PC[PC]
      Microphone[マイク] -- USB --> PC
      CaptureBoard -- HDMI --> Monitor[外部モニター]
   ```

   ※文字起こしする場合は、マイクも接続してください。

### 4.2. アプリ起動

アプリケーションを起動します（2.3.1 でビルド済みの場合）：

```bash
# Task経由（推奨）
task run

# または直接実行
.\backend\dist\SplatReplay\SplatReplay.exe
```

> **Note**: ソースコードを変更した場合は、`task build` で再ビルドしてから起動してください。

### 4.3. 初回設定

### 4.3.1. OBS Studio の設定

1. OBS Studio を起動
2. ソースを追加:
   - 「ソース」パネルの「+」ボタン →「映像キャプチャデバイス」
   - キャプチャーデバイスを選択し、解像度を 1080p、フレームレートを 60fps に設定
3. WebSocket 設定:
   1. 「ツール」メニュー →「WebSocket Server Settings」
   2. 「WebSocket server 有効」にチェック
   3. パスワードをメモしておく。(後の設定で使用)
4. NDI 出力設定:
   1. 「ツール」メニュー →「DistroAV NDI Settings」
   2. 「Main Output」にチェックを入れる
5. 出力設定

#### 4.3.2. YouTube 認証

1. アプリ初回起動、もしくは認証の有効期限が切れたとき、YouTube 認証のためにブラウザが開きます
2. Google アカウントでログインし、必要な権限を許可
3. 「アクセスを許可しました。このタブを閉じて先に進んでください。」と表示されたらブラウザタブを閉じる
4. 認証情報が`token.pickle`ファイルに自動保存される

#### 4.3.3. 文字起こし設定

1. セットアップウィザードの「文字起こし設定」ステップを開く
2. **マイク名**: Windows のサウンド設定で表示される入力デバイス名を入力
3. **Groq API キー**: 2.2.3 で取得したキーを入力
4. **言語**: `ja-JP` などの言語コードを入力
5. **カスタム辞書**: 認識させたい単語を 1 行ずつ入力
6. 文字起こしを使用しない場合はスキップする

#### 4.3.4. アプリ設定

1. 設定ボタンをクリックし、設定画面を開く。
2. 強調表示されている必須項目を設定し、保存する。
   - 文字起こしを使用する場合は「文字起こし」セクションでマイク名 / Groq API キー / 言語 / 辞書を確認する。

## 5. 仕様概要

### 5.1. バトル録画の仕組み

通常通りバトルをするだけで、以下のようにシステムが自動で録画・編集・アップロード処理を実行します。

- システムはバックグラウンドで動作し、画面を常時監視
- スプラトゥーンのバトル開始を自動検出すると録画を開始
- バトル終了時に自動的に録画を停止し、メタデータ（ルール、ステージ、勝敗など）を抽出
- バトル情報を含む動画ファイルが自動的に作成される
- 連続したバトルはそれぞれ個別のファイルとして記録される

### 5.2. システムの停止

- 通常の停止: アプリケーションウィンドウを閉じる（× ボタンをクリック）
- 強制停止が必要な場合: Ctrl+C キーを押す

### 5.3. 編集時の動画のグルーピング

録画されたバトルは以下のルールでグループ化され YouTube にアップロードされます:

- 同じタイムスケジュールのバトル（例: 21-23 時）
- 同じマッチタイプ（ナワバリバトル、バンカラマッチなど）
- 同じルール（ガチエリア、ガチヤグラなど）

### 5.4. 動画のタイトルと説明

- **タイトル例 (デフォルト設定の場合)**:

  ```
  Xマッチ(XP19-20) ガチヤグラ 5勝3敗 '25.05.17 21時～
  ```

- **説明文例 (デフォルト設定の場合)**:
  ```
  XP: 2000.0
  00:00:00 WIN  5k 3d 2s デカライン高架下
  00:10:25 LOSE 3k 5d 1s ゴンズイ地区
  ...
  ```

### 5.5. サムネイル

- 自動生成されるサムネイルには以下の情報が含まれます:
  - 勝敗数（○ 勝 × 敗の表示）
  - バトル種別（X マッチ、ナワバリなど）
  - ルール（ガチアサリ、ガチエリアなど）
  - レート情報（XP、ウデマエ）
  - プレイしたステージ情報

## 6. カスタマイズ設定

### 6.1. サムネイル画像のカスタマイズ

サムネイルをカスタマイズする方法:

1. 1920x1080 サイズの PNG 画像を作成
2. `assets\thumbnail`フォルダに`thumbnail_overlay.png`として保存

- **透過あり**の場合: 透過部分に自動生成サムネイルが表示され、非透過部分に独自の装飾が表示される
- **透過なし**の場合: 完全にカスタムサムネイルで置き換えられる（自動生成は無効化）

**ヒント**: 自分のロゴやチャンネルアイコンを透過付きで配置するのがおすすめです。

## 7. トラブルシューティング

### 7.1. Switch の電源 OFF を検知できない

- **原因**: キャプチャボードによっては、Switch 電源 OFF 時の画面が異なり、検知できない場合があります。
- **対処法**:
  1. Switch 電源を OFF にした状態の画面をキャプチャ
  2. OBS でスクリーンショットを取得
  3. 画像を`assets\templates`フォルダに`power_off.png`として保存

### 7.2. "キャプチャデバイス未接続" と表示される

- **原因**: キャプチャボードが接続されていない、または認識されていない
- **対処法**:
  - キャプチャボードの接続を確認
  - 設定画面でデバイスインデックスを変更
  - 他のアプリケーションがカメラを使用していないか確認

### 7.3. OBS で「エンコードが高負荷です」と表示される/録画された動画がカクつく

- **原因**: PC の性能不足や OBS の設定が高負荷になっている
- **対処法**:
  - 本アプリを最小化する (リソース使用量を削減)
  - 解像度やフレームレートを下げる
  - 不要なソフトウェアを終了してリソースを確保
