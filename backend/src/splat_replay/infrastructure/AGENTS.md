# Infrastructure 層 - 実装ガイドライン

このドキュメントは、インフラストラクチャ層を変更する際の **最小ルール** を定義する。

---

## 1. インフラストラクチャ層の責務

インフラストラクチャ層は **外部システムとの連携** を担当する。ポート（application.interfaces）の実装を提供する。

**含むもの**：

- アダプタ実装（Adapters）
- リポジトリ実装
- 外部ライブラリのラッパー
- ファイル I/O
- API クライアント
- データベースアクセス
- メッセージキュー

**含まないもの**：

- ビジネスルール（domain 層に委譲）
- ユースケース（application 層に委譲）
- UI ロジック（interface 層に委譲）

---

## 2. 依存関係のルール

### 許可事項

- domain 層への依存（models, events, exceptions）
- application 層のポート実装（application.interfaces）
- 外部ライブラリ（cv2, numpy, structlog など）
- インフラ層内の相互参照（adapters, matchers, repositories）

### 禁止事項（絶対 NG）

- interface 層への直接依存（api, gui など）

---

## 3. 実装パターン

### 3.1 アダプタ（Adapters）

- ポート（Protocol）の具象実装
- 外部ライブラリの詳細を隠蔽
- エラーはドメイン例外に変換
- ログは構造化（`structlog`）

### 3.2 外部ライブラリのラッパー

- ライブラリ固有の型（`np.ndarray` など）をアダプタ内で完結
- 可能であれば標準型に変換
- キャッシュ等の最適化はアダプタ内で実装

### 3.3 リポジトリ実装

- ドメインモデルと永続化層の相互変換
- エラーはドメイン例外に変換
- トランザクション管理（必要な場合）

### 3.4 API クライアント

- API 固有のエラーをドメイン例外に変換
- リトライロジックは必要に応じて実装
- タイムアウト設定を必須にする

---

## 4. エラーハンドリング

### 4.1 ドメイン例外への変換

外部システムのエラーは必ずドメイン例外に変換する。

- RepositoryError: ファイル・DB エラー
- ExternalServiceError: API・外部サービスエラー
- ValidationError: データ検証エラー

### 4.2 ログ記録

すべての I/O 操作はログに記録する（`structlog`）。

- info: 正常処理（保存成功、API 呼び出し成功）
- error: エラー発生（保存失敗、API 呼び出し失敗）

---

## 5. パフォーマンス最適化

### 5.1 キャッシュ

頻繁にアクセスされるデータはキャッシュする（`lru_cache`）。

### 5.2 非同期 I/O

ブロッキング I/O は `asyncio` で非同期化する。

### 5.3 バッチ処理

複数の操作はバッチ化する（`asyncio.gather`）。

---

## 6. アンチパターン（やってはいけない）

### ❌ ビジネスロジックの実装

- アダプタでバリデーションしない
- ビジネスルールはドメイン層に委譲

### ❌ ポートを実装しないアダプタ

- メソッド名をポートと一致させる
- ポートを明示的に実装

### ❌ グローバル状態

- グローバル変数を使用しない
- インスタンス変数で状態を管理

---

## 7. テスト戦略

- 外部依存はモック（`unittest.mock` / `pytest-mock`）
- ファイル I/O は `tmp_path` フィクスチャを使用
- API は `httpx.MockTransport` でモック

---

## 8. DI 登録

アダプタは DI コンテナに登録する（`backend/src/splat_replay/infrastructure/di/`）。

- Singleton: ステートレスなアダプタ
- Factory: 状態を持つアダプタ

---

## 9. 参考資料

- ルート `AGENTS.md` - 全体方針とレイヤ間ルール
- `docs/internal_design.md` - 設計思想の詳細
