# Application 層 - 実装ガイドライン

このドキュメントは、アプリケーション層を変更する際の **最小ルール** を定義する。

---

## 1. アプリケーション層の責務

アプリケーション層は **ユースケース（業務フロー）** を実現する。ドメインモデルを組み合わせてユーザーストーリーを実装する。

**含むもの**：

- ユースケース（Use Cases）
- アプリケーションサービス（Services）
- ポート定義（Interfaces）
- イベントハンドラー
- DTO（Data Transfer Object）

**含まないもの**：

- ドメインロジック（domain 層に委譲）
- インフラ実装（infrastructure 層に委譲）
- UI ロジック（interface 層に委譲）

---

## 2. 依存関係のルール

### 許可事項

- ドメイン層への依存（models, services, events, exceptions）
- アプリケーション層内の相互参照（services, use_cases, interfaces）

### 禁止事項（絶対 NG）

- インフラ層への直接依存（adapters, matchers など）
- インターフェース層への直接依存（api, gui など）

---

## 3. 実装パターン

### 3.1 ユースケース（Use Cases）

- 1 ユースケース = 1 ユーザーストーリー
- コンストラクタインジェクション（ポート経由）
- `execute()` メソッドで開始
- ドメインロジックは domain 層に委譲
- I/O 処理はポート経由

### 3.2 アプリケーションサービス（Services）

- 単一責任原則（1 サービス = 1 責務）
- 状態を持たない（Stateless）
- ドメインサービスとポートを組み合わせる
- 複数のユースケースで再利用される業務フローを実装

### 3.3 ポート定義（Interfaces）

- `Protocol` で定義（duck typing）
- `application.interfaces` モジュールに配置
- 実装は `infrastructure.adapters` に配置
- メソッドは `...` で実装しない

### 3.4 イベントハンドラー

- イベント購読は interface 層で登録
- ハンドラーは application 層で実装
- 副作用（I/O）はポート経由

### 3.5 DTO（Data Transfer Object）

- `frozen=True` で不変
- `from_domain()` / `to_domain()` で変換
- interface 層で使用

---

## 4. サービス設計の原則適用

### 4.1 単一責任原則の適用

- 1 サービス = 1 責務
- ファイルが大きくなりすぎた場合は責務で分割を検討（目安: 数百行）
- 変更理由が複数ある場合は分割のシグナル

### 4.2 依存性の逆転原則の適用

- infrastructure 層の具象クラスに直接依存しない
- `application.interfaces` のポート（Protocol）に依存
- コンストラクタインジェクションで依存を注入

### 4.3 状態の管理

- サービスは **Stateless** を原則とする
- 状態が必要な場合は **ドメインモデル** で管理

---

## 5. アンチパターン（やってはいけない）

### ❌ インフラ層への直接依存

- アダプタを直接インポートしない
- ポート経由で DI する

### ❌ ドメインロジックの実装

- バリデーションはドメイン層で実装
- ビジネスルールをアプリケーション層に書かない

### ❌ 神サービス（God Service）

- 責務が多すぎる場合は分割
- 単一責任で分割する

---

## 6. チェックリスト

変更前に以下を確認：

- [ ] インフラ層（`infrastructure`）をインポートしていないか
- [ ] インターフェース層（`interface`）をインポートしていないか
- [ ] 外部依存はポート（`application.interfaces`）経由か
- [ ] ドメインロジックは domain 層に委譲しているか
- [ ] サービスは単一責任原則に従っているか
- [ ] ユースケースは 1 ユーザーストーリーに対応しているか
- [ ] 状態はドメインモデルで管理しているか

---

## 7. リファクタリング指針

### サービスの分割タイミング

以下のいずれかに該当する場合、分割を検討：

- ファイルが大きくなりすぎている（目安: 数百行）
- 複数の責務が混在している
- テストが書きにくい
- 変更頻度が高い

**注意**: 行数は絶対的な基準ではなく、あくまで目安。単一責任原則と保守性を優先して判断する。

### 分割手順

1. **責務を洗い出す**: メソッドをグループ化、依存関係を可視化
2. **新しいサービスを作成**: 単一責任で命名、ポート経由で依存
3. **元のサービスから移動**: メソッドをコピー、テストを移動、元から削除
4. **呼び出し元を更新**: DI コンテナに登録、呼び出し元を修正
